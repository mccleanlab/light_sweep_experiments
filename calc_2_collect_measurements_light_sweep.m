% This script gets all measurements for a given experiment, labels them
% from a plate map (.xlsx file), and collects them into a table, which is
% saved a .mat file into the 'collected_measurements' folder. These .mat
% files can then be accessed via a datastore to analyze and plot the
% results from many experiments. This script also does some basic
% processing to identify frames that should be dropped and identify the
% background fluorescence level in each well.

%% Clean up
clearvars; clc; close all

%% Set folders containing files to be analyzed
folder_list = {...
    %     'E:\microscopy\light_sweep_experiments\20210715_1'...
    %     'E:\microscopy\light_sweep_experiments\20210715_2'...
    %     'E:\microscopy\light_sweep_experiments\20210715_3'...
    %     'E:\microscopy\light_sweep_experiments\20210716_1'...
    %     'E:\microscopy\light_sweep_experiments\20210716_2'...
    %     'E:\microscopy\light_sweep_experiments\20210716_3'...
    %     'E:\microscopy\light_sweep_experiments\20210719_2'...
    %     'E:\microscopy\light_sweep_experiments\20210719_3'...
    %     'E:\microscopy\light_sweep_experiments\20210720_1'...
    %     'E:\microscopy\light_sweep_experiments\20210720_2'...
    %     'E:\microscopy\light_sweep_experiments\20210720_3'...
    %     'E:\microscopy\light_sweep_experiments\20210721_1'...
    %     'E:\microscopy\light_sweep_experiments\20210721_2'...
    %     'E:\microscopy\light_sweep_experiments\20210721_3'...
    %     'E:\microscopy\light_sweep_experiments\20210722_1'...
    %     'E:\microscopy\light_sweep_experiments\20210722_2'...
    %     'E:\microscopy\light_sweep_experiments\20210722_3'...
    %     'E:\microscopy\light_sweep_experiments\20210723_2'...
    %     'E:\microscopy\light_sweep_experiments\20210723_3'...
    %     'E:\microscopy\light_sweep_experiments\20210727_1'...
    %     'E:\microscopy\light_sweep_experiments\20210727_2'...
    %     'E:\microscopy\light_sweep_experiments\20210727_3'...
    %     'E:\microscopy\light_sweep_experiments\20210729_1'...
    %     'E:\microscopy\light_sweep_experiments\20210729_2'...
    %     'E:\microscopy\light_sweep_experiments\20210729_3'...
    %     'E:\microscopy\light_sweep_experiments\20210730_1'...
    %     'E:\microscopy\light_sweep_experiments\20210730_3'...
    %     'E:\microscopy\light_sweep_experiments\20210802_1'...
    %     'E:\microscopy\light_sweep_experiments\20210802_2'...
    %     'E:\microscopy\light_sweep_experiments\20210802_3'...
    %     'E:\microscopy\light_sweep_experiments\20210803_1'...
    %     'E:\microscopy\light_sweep_experiments\20210803_2'...
    %     'E:\microscopy\light_sweep_experiments\20210803_3'...
    %     'E:\microscopy\light_sweep_experiments\20210804_1'...
    %     'E:\microscopy\light_sweep_experiments\20210804_2'...
    %     'E:\microscopy\light_sweep_experiments\20210804_3'...
    %     'E:\microscopy\light_sweep_experiments\20210805_1'...
    %     'E:\microscopy\light_sweep_experiments\20210805_2'...
    %     'E:\microscopy\light_sweep_experiments\20210806_1'...
    %     'E:\microscopy\light_sweep_experiments\20210806_2'...
    %     'E:\microscopy\light_sweep_experiments\20210806_3'...
    %     'E:\microscopy\light_sweep_experiments\20210808_1'...
    %     'E:\microscopy\light_sweep_experiments\20210809_1'...
    %     'E:\microscopy\light_sweep_experiments\20210809_2'...
    %     'E:\microscopy\light_sweep_experiments\20210809_3'...
    %     'E:\microscopy\light_sweep_experiments\20210810_1'...
    %     'E:\microscopy\light_sweep_experiments\20210810_2'...
    %     'E:\microscopy\light_sweep_experiments\20210810_3'...
    %     'E:\microscopy\light_sweep_experiments\20210812_1'...
    %     'E:\microscopy\light_sweep_experiments\20210812_2'...
    %     'E:\microscopy\light_sweep_experiments\20210812_3'...
    %     'E:\microscopy\light_sweep_experiments\20210813_1'...
    %     'E:\microscopy\light_sweep_experiments\20210813_2'...
    %     'E:\microscopy\light_sweep_experiments\20210813_3'...
    %     'E:\microscopy\light_sweep_experiments\20210817_1'...
    %     'E:\microscopy\light_sweep_experiments\20210817_2'...
    %     'E:\microscopy\light_sweep_experiments\20210818_1'...
    %     'E:\microscopy\light_sweep_experiments\20210818_2'...
    %     'E:\microscopy\light_sweep_experiments\20210818_3'...
    %     'E:\microscopy\light_sweep_experiments\20210819_1'...
    %     'E:\microscopy\light_sweep_experiments\20210819_2'...
    %     'E:\microscopy\light_sweep_experiments\20210819_3'...
    %     'E:\microscopy\light_sweep_experiments\20210820_1'...
    %     'E:\microscopy\light_sweep_experiments\20210820_2'...
    %     'E:\microscopy\light_sweep_experiments\20210820_3'...
    %     'E:\microscopy\light_sweep_experiments\20210823_1'...
    %     'E:\microscopy\light_sweep_experiments\20210823_2'...
    %     'E:\microscopy\light_sweep_experiments\20210823_3'...
    %     'E:\microscopy\light_sweep_experiments\20210824_1'...
    %     'E:\microscopy\light_sweep_experiments\20210824_2'...
    %     'E:\microscopy\light_sweep_experiments\20210824_3'...
    %     'E:\microscopy\light_sweep_experiments\20210827_1'...
    %     'E:\microscopy\light_sweep_experiments\20210827_2'...
    %     'E:\microscopy\light_sweep_experiments\20210827_3'...
    %     'E:\microscopy\light_sweep_experiments\20210830_1'...
    %     'E:\microscopy\light_sweep_experiments\20210830_2'...
    %     'E:\microscopy\light_sweep_experiments\20210830_3'...
    %     'E:\microscopy\light_sweep_experiments\20210831_2'...
    %     'E:\microscopy\light_sweep_experiments\20210831_3'...
    %     'E:\microscopy\light_sweep_experiments\20210901_1'...
    %     'E:\microscopy\light_sweep_experiments\20210901_2'...
    %     'E:\microscopy\light_sweep_experiments\20210901_3'...
    %     'E:\microscopy\light_sweep_experiments\20210902_1'...
    %     'E:\microscopy\light_sweep_experiments\20210902_2'...
    %     'E:\microscopy\light_sweep_experiments\20210902_3'...
    %     'E:\microscopy\light_sweep_experiments\20210903_1'...
    };

%% Set output folder for collected measurements
parent_folder = 'D:\Google Drive\light_sweep_shared\light_sweep_experiments\';
collected_measurements_folder = fullfile(parent_folder,'collected_measurements');

%% Loop through folders and process
for f = 1:numel(folder_list)
    
    % Import .mat files from folder and collect in table
    folder = folder_list{f};
    cd(folder);
    
    data = import_mat_table(fullfile(pwd,'output'),[]);
    data.well = string(regexp(string(data.sourceFile),'((?<=well).*?(?=_))','match'));
    data.time = data.time/60 - 10;
    
    % Label measurements
    labels_file = dir('*.xlsx');
    labels = get_labels(fullfile(labels_file.folder,labels_file.name));
    [~, experiment_name, ~] = fileparts(fullfile(labels_file.folder,labels_file.name));
    labels.experiment(:,1) = categorical(string(experiment_name));
    experiment_name_tex = string(strrep(experiment_name,'_','\_'));
    
    data = join(data,labels);
    data.condition = double(data.condition);
    
    % Combine batch controls into condition 16 but add term to identify
    data.batch_control_type(:,1) = categorical("none");
    data.batch_control_type(data.condition==16) = categorical("light");
    data.batch_control_type(data.condition==17) = categorical("dark");
    data.condition(data.condition==17) = 16;
    
    % Label light program
    light_program_labels = get_labels(fullfile(labels_file.folder,labels_file.name),'optoplate_config');
    data = join(data,light_program_labels);
    
    % Append tex labels to color code Msn2 mutants
    plot_settings_folder = 'D:\Google Drive\light_sweep_shared';
    Msn2_tex = readtable(fullfile(plot_settings_folder,'plot_settings.xlsx'),'Sheet','Msn2_tex');
    Msn2_tex.Msn2 = string(Msn2_tex.Msn2);
    Msn2_tex.Msn2_tex = string(Msn2_tex.Msn2_tex);
    data = join(data,Msn2_tex);
    
    % Filter out dropped frames
    data_outliers = grpstats(data,{'well','frame'},'mean','DataVars','iRFP_nuclear_mean');
    data_outliers_mad = grouptransform(data_outliers,'well',@(x) isoutlier(detrend(x,2),'ThresholdFactor',4),'GroupCount');
    data_outliers_mad(:,end) = [];
    data_outliers_mad.Properties.VariableNames(end) = {'drop_frame'};
    data_outliers = join(data_outliers,data_outliers_mad);
    
    data = join(data,data_outliers);
    
    % Plot cell count per frame
    clc; clear g; close all; figure('units','normalized','outerposition',[0 0 0.6 0.9]);
    g = gramm('x',data_outliers.frame,'y',data_outliers.GroupCount);
    g.facet_grid(cellstr(regexp(data_outliers.well,'[A-H]','match')),cellstr(regexp(data_outliers.well,'\d{2}','match')),'scale','independent');
    g.geom_line();
    g.set_text_options('base_size',6);
    g.set_names('x','frame','y','# cells','column','','row','','color','drop frame');
    g.draw();
    
    % Plot dropped frames over cell count
    g.update('color',(data_outliers.drop_frame));
    g.geom_point();
    g.set_point_options('base_size',3);
    g.draw();
    g.redraw(0.025);
    g.export('file_name',[experiment_name '_dropped_frames'],'file_type','png');
    
    %     % Calculate BG fluorescence (mode_well(mode_frame(fluorescence))
    %     data_BG = grpstats(data(data.time<=t_basal,:),{'well','reporter'},@mode,'DataVars',{'iRFP_BG','mScarlet_BG','mCitrine_BG'});
    %     data_BG = clean_grpstats(data_BG);
    %     data_BG.Properties.VariableNames(end-2:end) = {'mode_iRFP_BG','mode_mScarlet_BG','mode_mCitrine_BG'};
    %     data = join(data,data_BG);
    
    % Save collected & labeled measurements for experiment
    strain_list = unique(data.strain(data.condition==1));
    plasmid_list = unique(data.plasmid(data.condition==1));
    if numel(strain_list)==2 && numel(plasmid_list)==1
        filename_out = strcat(experiment_name,'_',strain_list(1),'_',strain_list(2),'_',plasmid_list(1),'.mat');
    else
        filename_out = strcat(experiment_name,'_',strain_list(1),'_',plasmid_list(1),'_',plasmid_list(2),'.mat');
    end
    save(fullfile(collected_measurements_folder,filename_out),'data');
    
end