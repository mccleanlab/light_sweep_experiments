% Run this script to execute cell tracking functions.
%% Clear variables and suppress warnings
clearvars;close all;clc
tnet = tic;

warning('off', 'images:imfindcircles:warnForLargeRadiusRange');
warning('off', 'images:imfindcircles:warnForSmallRadius');
warning('off', 'images:initSize:adjustingMag');

%% Select folders containing files to be analyzed

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% pause(1800) % PAUSE UNTIL FILES DOWNLOADED. REMEMBER TO DISABLE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

folder_list = {...
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % LIGHT SWEEP EXPERIMENTS
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %     'E:\microscopy\light_sweep_experiments\20210715_1'...
    %     'E:\microscopy\light_sweep_experiments\20210715_2'...
    %     'E:\microscopy\light_sweep_experiments\20210715_3'...
    %     'E:\microscopy\light_sweep_experiments\20210716_1'...
    %     'E:\microscopy\light_sweep_experiments\20210716_2'...
    %     'E:\microscopy\light_sweep_experiments\20210716_3'...
    %     'E:\microscopy\light_sweep_experiments\20210719_2'...
    %     'E:\microscopy\light_sweep_experiments\20210719_3'...
    %     'E:\microscopy\light_sweep_experiments\20210720_1'...
    %     'E:\microscopy\light_sweep_experiments\20210720_2'...
    %     'E:\microscopy\light_sweep_experiments\20210720_3'...
    %     'E:\microscopy\light_sweep_experiments\20210721_1'...
    %     'E:\microscopy\light_sweep_experiments\20210721_2'...
    %     'E:\microscopy\light_sweep_experiments\20210721_3'...
    %     'E:\microscopy\light_sweep_experiments\20210722_1'...
    %     'E:\microscopy\light_sweep_experiments\20210722_2'...
    %     'E:\microscopy\light_sweep_experiments\20210722_3'...
    %     'E:\microscopy\light_sweep_experiments\20210723_2'...
    %     'E:\microscopy\light_sweep_experiments\20210723_3'...
    %     'E:\microscopy\light_sweep_experiments\20210727_1'...
    %     'E:\microscopy\light_sweep_experiments\20210727_2'...
    %     'E:\microscopy\light_sweep_experiments\20210727_3'...
    %     'E:\microscopy\light_sweep_experiments\20210729_1'...
    %     'E:\microscopy\light_sweep_experiments\20210729_2'...
    %     'E:\microscopy\light_sweep_experiments\20210729_3'...
    %     'E:\microscopy\light_sweep_experiments\20210730_1'...
    %     'E:\microscopy\light_sweep_experiments\20210730_3'...
    %     'E:\microscopy\light_sweep_experiments\20210802_1'...
    %     'E:\microscopy\light_sweep_experiments\20210802_2'...
    %     'E:\microscopy\light_sweep_experiments\20210802_3'...
    %     'E:\microscopy\light_sweep_experiments\20210803_1'...
    %     'E:\microscopy\light_sweep_experiments\20210803_2'...
    %     'E:\microscopy\light_sweep_experiments\20210803_3'...
    %     'E:\microscopy\light_sweep_experiments\20210804_1'...
    %     'E:\microscopy\light_sweep_experiments\20210804_2'...
    %     'E:\microscopy\light_sweep_experiments\20210804_3'...
    %     'E:\microscopy\light_sweep_experiments\20210805_1'...
    %     'E:\microscopy\light_sweep_experiments\20210805_2'...
    %     'E:\microscopy\light_sweep_experiments\20210806_1'...
    %     'E:\microscopy\light_sweep_experiments\20210806_2'...
    %     'E:\microscopy\light_sweep_experiments\20210806_3'...
    %     'E:\microscopy\light_sweep_experiments\20210808_1'...
    %     'E:\microscopy\light_sweep_experiments\20210809_1'...
    %     'E:\microscopy\light_sweep_experiments\20210809_2'...
    %     'E:\microscopy\light_sweep_experiments\20210809_3'...
    %     'E:\microscopy\light_sweep_experiments\20210810_1'...
    %     'E:\microscopy\light_sweep_experiments\20210810_2'...
    %     'E:\microscopy\light_sweep_experiments\20210810_3'...
    %     'E:\microscopy\light_sweep_experiments\20210812_1'...
    %     'E:\microscopy\light_sweep_experiments\20210812_2'...
    %     'E:\microscopy\light_sweep_experiments\20210812_3'...
    %     'E:\microscopy\light_sweep_experiments\20210813_1'...
    %     'E:\microscopy\light_sweep_experiments\20210813_2'...
    %     'E:\microscopy\light_sweep_experiments\20210813_3'...
    %     'E:\microscopy\light_sweep_experiments\20210817_1'...
    %     'E:\microscopy\light_sweep_experiments\20210817_2'...
    %     'E:\microscopy\light_sweep_experiments\20210818_1'...
    %     'E:\microscopy\light_sweep_experiments\20210818_2'...
    %     'E:\microscopy\light_sweep_experiments\20210818_3'...
    %     'E:\microscopy\light_sweep_experiments\20210819_1'...
    %     'E:\microscopy\light_sweep_experiments\20210819_2'...
    %     'E:\microscopy\light_sweep_experiments\20210819_3'...
    %     'E:\microscopy\light_sweep_experiments\20210820_1'...
    %     'E:\microscopy\light_sweep_experiments\20210820_2'...
    %     'E:\microscopy\light_sweep_experiments\20210820_3'...
    %     'E:\microscopy\light_sweep_experiments\20210823_1'...
    %     'E:\microscopy\light_sweep_experiments\20210823_2'...
    %     'E:\microscopy\light_sweep_experiments\20210823_3'...
    %     'E:\microscopy\light_sweep_experiments\20210824_1'...
    %     'E:\microscopy\light_sweep_experiments\20210824_2'...
    %     'E:\microscopy\light_sweep_experiments\20210824_3'...
    %     'E:\microscopy\light_sweep_experiments\20210827_1'...
    %     'E:\microscopy\light_sweep_experiments\20210827_2'...
    %     'E:\microscopy\light_sweep_experiments\20210827_3'...
    %     'E:\microscopy\light_sweep_experiments\20210830_1'...
    %     'E:\microscopy\light_sweep_experiments\20210830_2'...
    %     'E:\microscopy\light_sweep_experiments\20210830_3'...
    %     'E:\microscopy\light_sweep_experiments\20210831_2'...
    %     'E:\microscopy\light_sweep_experiments\20210831_3'...
    %     'E:\microscopy\light_sweep_experiments\20210901_1'...
    %     'E:\microscopy\light_sweep_experiments\20210901_2'...
    %     'E:\microscopy\light_sweep_experiments\20210901_3'...
    %     'E:\microscopy\light_sweep_experiments\20210902_1'...
    %     'E:\microscopy\light_sweep_experiments\20210902_2'...
    %     'E:\microscopy\light_sweep_experiments\20210902_3'...
    %     'E:\microscopy\light_sweep_experiments\20210903_1'...
    };

%% Set parameters for image processing
params.sizeNuc = [5 10];
params.sizeCell = [14 22];
params.nucGamma = 1;
params.cellGamma = 0.90;
params.nucPolarity = 'bright';
params.cellPolarity = 'bright';
params.nucSensitivity = 0.925;
params.cellSensitivity = 0.925;
params.nucEdgeThresh = 0.05;
params.cellEdgeThresh = 0.01;
params.nucDilate = 3;
params.sizeNucForce = [6 18];
params.sizeCellForce = [12 24];
params.sizeCellScale = 1;
params.nucToCellScale = 2;
params.nucOverlapThresh = -0.10;
params.cellOverlapThresh = 0.75;
params.nucCellOverlapThresh = 1;
params.deadOverlap = 0.75;
params.lifespan = 1;
params.trackGap = 5;
params.trackMaxDist = 20;
params.smoothFilterSize = [5, 5, 5, 5, 5, 3];
params.medFilterSize = 0;
params.displayCells = 0;
params.displayTrackID = 1;
params.tableType = '.mat';

%% Track and measure cells
for f = 1:numel(folder_list)
    folder = folder_list{f};
    cd(folder);
    
    % Get list of .ND2 files in folder
    image_list = dir('*.ND2');
    image_list = {image_list.name};
    
    for i = 1:numel(image_list) %1:numel(image_list)
        
        
        
        %% Load image
        try
            params.frame_position_switch = false;
            [images, params] = load_ND2_metadata(image_list,i,{'iRFP','mScarlet','mCitrine'},1,params);
        catch
            params.frame_position_switch = true;
            [images, params] = load_ND2_metadata(image_list,i,{'iRFP','mScarlet','mCitrine'},1,params);
        end
        
        %% Find and measure cells
        close all
        
        % Find cells and nucle
        cell_ROIs = find_cells(images, 'iRFP', [], params,@preprocess_imNuc, @preprocess_imCell); % Find ROIs
        
        % Measure cells
        cell_measurements = measure_cells(images,{'iRFP','mScarlet','mCitrine'},cell_ROIs,params); % Measure cells
        
        % Export measurements
        cell_measurements = join(cell_measurements,images.metadata);
        export_cell_measurements(cell_measurements,params); % Export measurements
        export_cell_display(images,'mScarlet',cell_measurements,params,[]); % Export movie of tracked cells
    end
end

%% Clean up
tnet = toc(tnet);
disp(['Total elapsed time is ' num2str(tnet) ' seconds'])
% clearvars -except images params cellData celldataTrack cellMeasurements

%% Image preprocessing function definitions
function [imCellOut, params] = preprocess_imCell(imCellIn,params)
imCellOut = imCellIn;
threshold = prctile(imCellOut(:),99.9);
imCellOut(imCellOut>threshold) = threshold;

imCellOut = imCellIn;
n = 32;
sigma = 0.25;
filt = fspecial('log',n,sigma);
imCellOut = imfilter(imCellOut,filt,'replicate');
imCellOut = imerode(imCellOut,strel('disk',2));
imCellOut = imdilate(imCellOut,strel('disk',2));
imCellOut = imgaussfilt(imCellOut,2);
imCellOut = imdilate(imCellOut,strel('disk',12));
end

function [imCellOut, params] = preprocess_imNuc(imCellIn,params)
imCellOut = imCellIn;
threshold = prctile(imCellOut(:),99);
imCellOut(imCellOut>threshold) = threshold;

n = 64;
sigma = 0.5;
filt = fspecial('log',n,sigma);
imCellOut = imfilter(imCellOut,filt,'replicate');

imCellOut = imerode(imCellOut,strel('disk',2));
imCellOut = imgaussfilt(imCellOut,2);
imCellOut = imdilate(imCellOut,strel('disk',2));
imCellOut = imgaussfilt(imCellOut,2);
end

